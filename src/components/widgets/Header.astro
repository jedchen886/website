---
import Logo from '~/components/Logo.astro';
import { trimSlash } from '~/utils/permalinks';
import type { CallToAction } from '~/types';

interface Link {
  text?: string;
  href?: string;
  ariaLabel?: string;
  icon?: string;
}

interface MenuLink extends Link {
  links?: Array<MenuLink>;
}

export interface Props {
  id?: string;
  links?: Array<MenuLink>;
  actions?: Array<CallToAction>;
  isSticky?: boolean;
  isDark?: boolean;
  isFullWidth?: boolean;
  showToggleTheme?: boolean;
  showRssFeed?: boolean;
  position?: string;
  /** Set to 'light' for pages without hero section (dark text/logo on light bg) */
  defaultNavTheme?: 'dark' | 'light';
}

const {
  id = 'header',
  links = [],
  actions = [],
  isSticky = false,
  isDark = false,
  defaultNavTheme = 'dark', // 'dark' = white text for pages with dark hero
} = Astro.props;

const currentPath = `/${trimSlash(new URL(Astro.url).pathname)}`;

// Language detection and switcher
const pathname = Astro.url.pathname;
const isChinesePage = pathname.startsWith('/cn/') || pathname === '/cn' || pathname === '/cn/';
const isEnglishPage = pathname.startsWith('/en/') || pathname === '/en' || pathname === '/en/';

// Get the path without language prefix for switching
let pathWithoutLang = '';
if (pathname.startsWith('/en/')) {
  pathWithoutLang = pathname.slice(3);
} else if (pathname.startsWith('/cn/')) {
  pathWithoutLang = pathname.slice(3);
}

// Remove trailing slash and ensure proper format
pathWithoutLang = pathWithoutLang.replace(/\/$/, '');
if (pathWithoutLang && !pathWithoutLang.startsWith('/')) {
  pathWithoutLang = '/' + pathWithoutLang;
}

const langSwitchLink = isEnglishPage ? `/cn${pathWithoutLang}` : `/en${pathWithoutLang}`;
const langSwitchText = isEnglishPage ? '中文' : 'EN';

// Home link based on language
const homeLink = isChinesePage ? '/cn' : isEnglishPage ? '/en' : '/cn';
---

<!-- Main Navigation Bar -->
<div class="main-nav-bar" {...id ? { id } : {}} data-nav-default-theme={defaultNavTheme}>
  <div class="nav-fill"></div>
  <div class="border-bottom"></div>

  <div class="nav-row">
    <!-- Logo -->
    <div class="logo">
      <a href={homeLink} aria-label="Go to homepage" class="logo-click">
        <Logo />
      </a>
    </div>

    <!-- Desktop Navigation -->
    <nav class="desktop-nav" aria-label="Navigation Desktop">
      <ul>
        {
          links.map(({ text, href, links: subLinks }) => {
            // Check if this is the "服务与支持" menu for horizontal layout
            const isHorizontalMenu = text === '服务与支持';
            return (
            <li class={`${subLinks?.length ? 'nav-dropdown' : ''} ${isHorizontalMenu ? 'nav-dropdown-horizontal' : ''}`}>
              {subLinks?.length ? (
                <>
                  <div class="nav-link" data-link-status={href === currentPath ? 'active' : 'not-active'}>
                    <button type="button" class="link-click">
                      <span>{text}</span>
                      <svg class="dropdown-arrow" width="10" height="6" viewBox="0 0 10 6" fill="none">
                        <path d="M1 1L5 5L9 1" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                      </svg>
                    </button>
                  </div>
                  <ul class={`sub-links ${isHorizontalMenu ? 'sub-links-horizontal' : ''}`}>
                    {subLinks.map(({ text: subText, href: subHref }) => (
                      <li>
                        <a href={subHref}>{subText}</a>
                      </li>
                    ))}
                  </ul>
                </>
              ) : (
                <div class="nav-link" data-link-status={href === currentPath ? 'active' : 'not-active'}>
                  <a class="link-click" href={href}>
                    <span>{text}</span>
                  </a>
                </div>
              )}
            </li>
          )})
        }
      </ul>
    </nav>

    <!-- Desktop Actions (Language Switcher + CTA Button) -->
    <div class="nav-actions">
      <!-- Language Switcher (small, before CTA) -->
      <a class="lang-switcher lang-switcher-small" href={langSwitchLink}>
        {langSwitchText}
      </a>
      {
        actions?.length ? (
          actions.map((btnProps) => (
            <a class="cta-btn-gradient nav-cta-gradient" href={btnProps.href}>
              <span>{btnProps.text}</span>
            </a>
          ))
        ) : null
      }
    </div>

    <!-- Hamburger Menu Button (Mobile) -->
    <button
      class="hamburger"
      aria-label="Toggle menu"
      data-navigation-toggle="toggle"
    >
      <div class="hamburger-fill"></div>
      <div class="bar"></div>
      <div class="bar bar-bottom"></div>
    </button>
  </div>
</div>

<!-- Mobile Navigation -->
<div class="mobile-nav">
  <div class="overlay-dark" data-navigation-toggle="close"></div>

  <div class="mobile-nav-box">
    <!-- Mobile Logo -->
    <div class="box-row-logo">
      <a href={homeLink} aria-label="Go to homepage">
        <Logo />
      </a>
    </div>

    <!-- Mobile Nav Links -->
    <nav aria-label="Navigation Mobile">
      <ul class="mobile-nav-links">
        {
          links.map(({ text, href, links: subLinks }) => (
            <li class={subLinks?.length ? 'nav-dropdown' : ''}>
              {subLinks?.length ? (
                <>
                  <div class="nav-link" data-link-status={href === currentPath ? 'active' : 'not-active'}>
                    <button type="button" class="link-click" data-dropdown-toggle>
                      <span>{text}</span>
                      <svg class="dropdown-arrow" width="10" height="6" viewBox="0 0 10 6" fill="none">
                        <path d="M1 1L5 5L9 1" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                      </svg>
                    </button>
                  </div>
                  <ul class="sub-links">
                    {subLinks.map(({ text: subText, href: subHref }) => (
                      <li>
                        <a href={subHref}>{subText}</a>
                      </li>
                    ))}
                  </ul>
                </>
              ) : (
                <div class="nav-link" data-link-status={href === currentPath ? 'active' : 'not-active'}>
                  <a class="link-click" href={href}>
                    <span>{text}</span>
                  </a>
                </div>
              )}
            </li>
          ))
        }
      </ul>
    </nav>

    <!-- Mobile Language Switcher + CTA Button -->
    <div class="box-row-btn">
      <a class="lang-switcher-mobile" href={langSwitchLink}>
        {langSwitchText}
      </a>
      {
        actions?.length ? (
          actions.map((btnProps) => (
            <a class="cta-btn-gradient" href={btnProps.href}>
              <span>{btnProps.text}</span>
            </a>
          ))
        ) : null
      }
    </div>
  </div>
</div>

<!-- Floating Hamburger (appears on scroll down) -->
<button
  class="hamburger btn-floating"
  aria-label="Toggle menu"
  data-navigation-toggle="toggle"
>
  <div class="hamburger-fill"></div>
  <div class="bar"></div>
  <div class="bar bar-bottom"></div>
</button>
