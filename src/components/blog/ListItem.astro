---
import type { ImageMetadata } from 'astro';
import { Icon } from 'astro-icon/components';
import Image from '~/components/common/Image.astro';
import PostTags from '~/components/blog/Tags.astro';

import { APP_BLOG } from 'astrowind:config';
import type { Post } from '~/types';

import { getPermalink } from '~/utils/permalinks';
import { findImage } from '~/utils/images';
import { getFormattedDate } from '~/utils/utils';

export interface Props {
  post: Post;
}

const { post } = Astro.props;
const image = (await findImage(post.image)) as ImageMetadata | undefined;

// Detect current language from URL path
const currentPath = Astro.url.pathname;
const langPrefix = currentPath.startsWith('/en/') ? '/en' : currentPath.startsWith('/cn/') ? '/cn' : '';

const baseLink = APP_BLOG?.post?.isEnabled ? getPermalink(post.permalink, 'post') : '';
const link = baseLink ? `${langPrefix}${baseLink}` : '';
---

<article
  style="background: linear-gradient(145deg, rgba(192, 132, 252, 0.35) 0%, rgba(245, 235, 255, 1) 30%, rgba(255, 255, 255, 1) 50%, rgba(230, 250, 245, 1) 70%, rgba(0, 200, 150, 0.25) 100%); border-radius: 1.5rem; padding: 1.5rem; transition: all 0.3s ease; box-shadow: 0 8px 30px rgba(147, 51, 234, 0.15);"
  class="blog-article-card"
>
  <div class={`grid gap-6 md:gap-8 ${image ? 'md:grid-cols-2' : ''}`}>
    {
      image &&
        (link ? (
          <a class="relative block group" href={link ?? 'javascript:void(0)'}>
            <div
              style="position: relative; padding-bottom: 56.25%; overflow: hidden; border-radius: 1rem; background: linear-gradient(135deg, rgba(192, 132, 252, 0.5), rgba(0, 200, 150, 0.4)); box-shadow: 0 10px 35px rgba(147, 51, 234, 0.3);"
              class="blog-image-wrapper"
            >
              {image && (
                <Image
                  src={image}
                  class="absolute inset-0 object-cover w-full h-full rounded-xl"
                  widths={[400, 900]}
                  width={900}
                  sizes="(max-width: 900px) 400px, 900px"
                  alt={post.title}
                  aspectRatio="16:9"
                  loading="lazy"
                  decoding="async"
                />
              )}
            </div>
          </a>
        ) : (
          <div
            style="position: relative; padding-bottom: 56.25%; overflow: hidden; border-radius: 1rem; background: linear-gradient(135deg, rgba(192, 132, 252, 0.5), rgba(0, 200, 150, 0.4)); box-shadow: 0 10px 35px rgba(147, 51, 234, 0.3);"
            class="blog-image-wrapper"
          >
            {image && (
              <Image
                src={image}
                class="absolute inset-0 object-cover w-full h-full rounded-xl"
                widths={[400, 900]}
                width={900}
                sizes="(max-width: 900px) 400px, 900px"
                alt={post.title}
                aspectRatio="16:9"
                loading="lazy"
                decoding="async"
              />
            )}
          </div>
        ))
    }
    <div class="flex flex-col justify-center">
      <header>
        <div class="mb-2">
          <span class="text-sm text-slate-500">
            <Icon name="tabler:clock" class="w-3.5 h-3.5 inline-block -mt-0.5" />
            <time datetime={String(post.publishDate)} class="inline-block">{getFormattedDate(post.publishDate)}</time>
            {
              post.author && (
                <>
                  {' '}
                  · <Icon name="tabler:user" class="w-3.5 h-3.5 inline-block -mt-0.5" />
                  <span>{post.author.replaceAll('-', ' ')}</span>
                </>
              )
            }
            {
              post.category && (
                <>
                  {' '}
                  ·{' '}
                  <a class="hover:underline text-purple-600" href={`${langPrefix}${getPermalink(post.category.slug, 'category')}`}>
                    {post.category.title}
                  </a>
                </>
              )
            }
          </span>
        </div>
        <h2 class="text-xl sm:text-2xl font-bold leading-tight mb-3 text-gray-800">
          {
            link ? (
              <a
                class="inline-block hover:text-purple-600 transition ease-in duration-200"
                href={link}
              >
                {post.title}
              </a>
            ) : (
              post.title
            )
          }
        </h2>
      </header>

      {post.excerpt && <p class="flex-grow text-slate-600 text-base leading-relaxed">{post.excerpt}</p>}
      {
        post.tags && Array.isArray(post.tags) ? (
          <footer class="mt-4">
            <PostTags tags={post.tags} />
          </footer>
        ) : (
          <Fragment />
        )
      }
    </div>
  </div>
</article>

<style is:global>
  .blog-article-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 20px 40px rgba(147, 51, 234, 0.2);
  }

  .blog-article-card:hover .blog-image-wrapper {
    box-shadow: 0 12px 35px rgba(147, 51, 234, 0.25);
  }

  @media (min-width: 768px) {
    .blog-image-wrapper {
      padding-bottom: 75% !important;
      height: 18rem;
    }
  }

  @media (min-width: 1024px) {
    .blog-image-wrapper {
      padding-bottom: 56.25% !important;
    }
  }
</style>
